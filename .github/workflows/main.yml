name: CI/CD Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Build SvelteKit app
        run: npm run build

      - name: Create .env
        run: |
          mkdir -p /var/www/myapp/new
          cat <<EOF > /var/www/myapp/new/.env
          AUTH_GOOGLE_ID=${{ secrets.AUTH_GOOGLE_ID }}
          AUTH_GOOGLE_SECRET=${{ secrets.AUTH_GOOGLE_SECRET }}
          AUTH_DISCORD_ID=${{ secrets.AUTH_DISCORD_ID }}
          AUTH_DISCORD_SECRET=${{ secrets.AUTH_DISCORD_SECRET }}
          BETTER_AUTH_SECRET=${{ secrets.BETTER_AUTH_SECRET }}
          BETTER_AUTH_URL=${{ secrets.BETTER_AUTH_URL }}
          AUTH_DRIZZLE_URL=${{ secrets.AUTH_DRIZZLE_URL }}
          AUTH_DRIZZLE_URL_PROD=${{ secrets.AUTH_DRIZZLE_URL_PROD }}
          EOF

      - name: Move files to new release folder
        run: |
          set -xe
          mkdir -p /var/www/myapp/new
          rsync -avz --delete --exclude='.svelte-kit' src build server.ts package.json package-lock.json /var/www/myapp/new/

      - name: Finalize deployment
        run: |
          set -xe
          cd /var/www/myapp

          # Backup current release if exists
          [ -d current.bak ] && rm -rf current.bak
          [ -d current ] && mv current current.bak

          # Move new build into place
          mv new current
          cd current

          # Install production dependencies
          npm install --omit=dev

          # Run database migrations
          npm run drizzle:migrate

          # Start or restart app with PM2
          pm2 stop myapp || true
          pm2 start npm --name myapp -- start
          pm2 save